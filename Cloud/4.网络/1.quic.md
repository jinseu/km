## QUIC

Quick UDP Internet Connections。QUIC是一个基于UDP的传输层协议。

- 通过连接ID实现连接的迁移（适配移动网络）
- 通过Steam实现多路复用
- 允许应用自行选择拥塞控制算法，而不必受系统的限制

### Stream

和HTTP2类似，QUIC的数据都是以Stream的形式发送或接受，Steam由若干个Frame组成。相比于TCP协议，一条Strem 可以是双向的也可以是单向的。并且根据发起方的不同，Steam可以分为以下四种类型

- `Client-Initiated, Bidirectional` 对应Bits，0x0
- `Server-Initiated, Bidirectional` 对应Bits，0x1
- `Client-Initiated, Unidirectional` 对应Bits，0x2
- `Server-Initiated, Unidirectional` 对应Bits，0x3

在设计上Steam的状态更为简单，相比于TCP复杂的状态机，Steam包含两个较为简单的状态机，分别保存发送状态和接收状态，两个状态互不干扰。当然，如果是单向的Steam，那么在任意一侧，只会存在一个状态机。但是，大部分情况下为了简单起见，无论单向还是双向，都会保存两个状态机。

发送部分状态图，如下所示

```
          o
          | Create Stream (Sending)
          | Peer Creates Bidirectional Stream
          v
      +-------+
      | Ready | Send RESET_STREAM
      |       |-----------------------.
      +-------+                       |
          |                           |
          | Send STREAM /             |
          |      STREAM_DATA_BLOCKED  |
          |                           |
          | Peer Creates              |
          |      Bidirectional Stream |
          v                           |
      +-------+                       |
      | Send  | Send RESET_STREAM     |
      |       |---------------------->|
      +-------+                       |
          |                           |
          | Send STREAM + FIN         |
          v                           v
      +-------+                   +-------+
      | Data  | Send RESET_STREAM | Reset |
      | Sent  |------------------>| Sent  |
      +-------+                   +-------+
          |                           |
          | Recv All ACKs             | Recv ACK
          v                           v
      +-------+                   +-------+
      | Data  |                   | Reset |
      | Recvd |                   | Recvd |
      +-------+                   +-------+
```


接收部分状态图如下所示

```
          o
          | Recv STREAM / STREAM_DATA_BLOCKED / RESET_STREAM
          | Create Bidirectional Stream (Sending)
          | Recv MAX_STREAM_DATA / STOP_SENDING (Bidirectional)
          | Create Higher-Numbered Stream
          v
      +-------+
      | Recv  | Recv RESET_STREAM
      |       |-----------------------.
      +-------+                       |
          |                           |
          | Recv STREAM + FIN         |
          v                           |
      +-------+                       |
      | Size  | Recv RESET_STREAM     |
      | Known |---------------------->|
      +-------+                       |
          |                           |
          | Recv All Data             |
          v                           v
      +-------+ Recv RESET_STREAM +-------+
      | Data  |--- (optional) --->| Reset |
      | Recvd |  Recv All Data    | Recvd |
      +-------+<-- (optional) ----+-------+
          |                           |
          | App Read All Data         | App Read RST
          v                           v
      +-------+                   +-------+
      | Data  |                   | Reset |
      | Read  |                   | Read  |
      +-------+                   +-------+
```

#### Frame

**Stream Frame**

1. `Stream ID` 32位整数，作为唯一ID用来标识一个流
2. `Offset`
3. `Length`
4. `Data`

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                         Stream ID (i)                       ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                         [Offset (i)]                        ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                         [Length (i)]                        ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                        Stream Data (*)                      ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

STREAM
STREAM_DATA_BLOCKED
MAX_STREAM_DATA





#### 优先级

QUIC does not provide frames for exchanging prioritization information.  Instead it relies on receiving priority information from the application that uses QUIC.

### 基本特性

#### 链接建立（Connection Establishment）


#### 拥塞控制（Congestion Control）

#### 多路复用（Multiplexing）

#### 前向纠错（Forward Error Correction）

#### 链接迁移（Connection Migration）


### 协议解析

> https://tools.ietf.org/html/draft-ietf-quic-transport-20#section-19.8
